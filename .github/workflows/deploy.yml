name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master  # Adjust if your branch is named 'master'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Stop script on first error
            set -e

            echo "ğŸš€ Starting Deployment..."

            # Navigate to the project folder
            # IMPORTANT: This folder must be a git repository (git clone)
            cd ~/AdopPets

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code..."
            git checkout main
            git pull origin main

            # Rebuild Docker Images
            echo "ğŸ”¨ Building Backend Image..."
            docker build -t backend-service:latest ./Backend

            echo "ğŸ”¨ Building Auth Service Image..."
            docker build -t auth-service:latest ./auth_service

            echo "ğŸ”¨ Building Frontend Service Image..."
            docker build -t frontend-service:latest ./frontend_service

            # Export to K3s
            echo "ğŸ“¦ Importing images to K3s..."
            docker save backend-service:latest | sudo k3s ctr images import -
            docker save auth-service:latest | sudo k3s ctr images import -
            docker save frontend-service:latest | sudo k3s ctr images import -

            # Apply Kubernetes Configurations
            echo "â˜¸ï¸  Applying Manifests..."
            sudo kubectl apply -f k8s/

            # Force Restart Pods (to ensure they use the new image)
            echo "ğŸ”„ Restarting Deployments..."
            sudo kubectl rollout restart deployment backend-service
            sudo kubectl rollout restart deployment auth-service
            sudo kubectl rollout restart deployment frontend-service

            echo "âœ… Deployment Successful!"
